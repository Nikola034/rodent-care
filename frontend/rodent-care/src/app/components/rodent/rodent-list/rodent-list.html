<p-toast position="top-right"></p-toast>
<p-confirmDialog></p-confirmDialog>

<div class="rodent-list">
  <!-- Header -->
  <div class="flex align-items-center justify-content-between mb-4">
    <div>
      <h1 class="text-2xl font-bold text-color m-0">Rodents</h1>
      <p class="text-color-secondary mt-1 mb-0">Manage your rodent registry</p>
    </div>
    @if (canManageRodents()) {
      <p-button label="Add Rodent" icon="pi pi-plus" (onClick)="navigateToAddRodent()"></p-button>
    }
  </div>

  <!-- Filters -->
  <p-card styleClass="mb-4">
    <div class="grid">
      <div class="col-12 md:col-3">
        <span class="p-input-icon-left w-full">
          <i class="pi pi-search"></i>
          <input pInputText type="text" [(ngModel)]="searchName" placeholder="Search by name..."
            (ngModelChange)="onSearchChange()" class="w-full" />
        </span>
      </div>
      <div class="col-12 md:col-3">
        <p-dropdown [options]="speciesOptions" [(ngModel)]="selectedSpecies" placeholder="Filter by Species"
          (onChange)="onFilterChange()" styleClass="w-full"></p-dropdown>
      </div>
      <div class="col-12 md:col-3">
        <p-dropdown [options]="statusOptions" [(ngModel)]="selectedStatus" placeholder="Filter by Status"
          (onChange)="onFilterChange()" styleClass="w-full"></p-dropdown>
      </div>
      <div class="col-12 md:col-3">
        <p-dropdown [options]="sortOptions" [(ngModel)]="selectedSort" placeholder="Sort by"
          (onChange)="onFilterChange()" styleClass="w-full"></p-dropdown>
      </div>
    </div>
    @if (searchName || selectedSpecies || selectedStatus || selectedSort !== 'created_at:desc') {
      <div class="mt-3">
        <p-button label="Clear Filters" icon="pi pi-filter-slash" [text]="true" size="small"
          (onClick)="clearFilters()"></p-button>
      </div>
    }
  </p-card>

  <!-- Rodent Table -->
  <p-card>
    @if (isLoading) {
      <div class="flex flex-column gap-3">
        @for (i of [1, 2, 3, 4, 5]; track i) {
          <div class="flex align-items-center gap-3 p-3 surface-ground border-round">
            <p-skeleton shape="circle" size="4rem"></p-skeleton>
            <div class="flex-1">
              <p-skeleton width="30%" height="1.2rem" styleClass="mb-2"></p-skeleton>
              <p-skeleton width="50%" height="1rem"></p-skeleton>
            </div>
            <p-skeleton width="5rem" height="2rem"></p-skeleton>
          </div>
        }
      </div>
    } @else {
      <p-table [value]="rodents" [tableStyle]="{ 'min-width': '100%' }" styleClass="p-datatable-gridlines"
        [rowHover]="true">
        <ng-template pTemplate="header">
          <tr>
            <th>Rodent</th>
            <th>Species</th>
            <th>Gender</th>
            <th>Status</th>
            <th>Intake Date</th>
            @if (canManageRodents()) {
              <th style="width: 8rem">Actions</th>
            }
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-rodent>
          <tr class="cursor-pointer" (click)="navigateToRodent(rodent.id)">
            <td>
              <div class="flex align-items-center gap-3">
                @if (getPrimaryImage(rodent)) {
                  <img [src]="getPrimaryImage(rodent)" alt="{{ rodent.name }}"
                    class="border-round" style="width: 50px; height: 50px; object-fit: cover;" />
                } @else {
                  <div class="flex align-items-center justify-content-center bg-primary-100 border-round"
                    style="width: 50px; height: 50px;">
                    <i class="pi pi-heart-fill text-primary text-xl"></i>
                  </div>
                }
                <div>
                  <span class="font-semibold">{{ rodent.name }}</span>
                  @if (rodent.chip_id) {
                    <span class="block text-sm text-color-secondary">Chip: {{ rodent.chip_id }}</span>
                  }
                </div>
              </div>
            </td>
            <td>{{ getSpeciesLabel(rodent.species) }}</td>
            <td>
              <span class="capitalize">{{ rodent.gender }}</span>
            </td>
            <td>
              <p-tag [value]="getStatusLabel(rodent.status)" [severity]="getStatusSeverity(rodent.status)"></p-tag>
            </td>
            <td>{{ rodent.intake_date | date:'mediumDate' }}</td>
            @if (canManageRodents()) {
              <td>
                <div class="flex gap-2">
                  <p-button icon="pi pi-pencil" [rounded]="true" [text]="true"
                    (onClick)="navigateToEditRodent(rodent.id, $event)" pTooltip="Edit"></p-button>
                  <p-button icon="pi pi-trash" [rounded]="true" [text]="true" severity="danger"
                    (onClick)="confirmDelete(rodent, $event)" pTooltip="Delete"></p-button>
                </div>
              </td>
            }
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <tr>
            <td [attr.colspan]="canManageRodents() ? 6 : 5" class="text-center py-6">
              <div class="flex flex-column align-items-center">
                <i class="pi pi-inbox text-5xl text-color-secondary mb-3"></i>
                <p class="text-xl text-color-secondary mb-3">No rodents found</p>
                @if (searchName || selectedSpecies || selectedStatus) {
                  <p-button label="Clear Filters" icon="pi pi-filter-slash" [outlined]="true"
                    (onClick)="clearFilters()"></p-button>
                } @else if (canManageRodents()) {
                  <p-button label="Add Your First Rodent" icon="pi pi-plus"
                    (onClick)="navigateToAddRodent()"></p-button>
                }
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>

      @if (totalRecords > rows) {
        <p-paginator [first]="first" [rows]="rows" [totalRecords]="totalRecords"
          [rowsPerPageOptions]="[10, 25, 50]" (onPageChange)="onPageChange($event)"
          styleClass="mt-3"></p-paginator>
      }
    }
  </p-card>
</div>
