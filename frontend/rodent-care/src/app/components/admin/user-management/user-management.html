<p-toast position="top-right"></p-toast>
<p-confirmDialog></p-confirmDialog>

<div class="user-management">
  <!-- Header -->
  <div class="mb-4">
    <h1 class="text-2xl font-bold text-color m-0">User Management</h1>
    <p class="text-color-secondary mt-1 mb-0">Manage user accounts and permissions</p>
  </div>

  <p-card>
    @if (isLoading) {
      <div class="flex justify-content-center py-6">
        <p-progressSpinner></p-progressSpinner>
      </div>
    } @else {
      <p-table [value]="users" [tableStyle]="{ 'min-width': '100%' }" styleClass="p-datatable-gridlines"
        [rowHover]="true">
        <ng-template pTemplate="header">
          <tr>
            <th>User</th>
            <th>Email</th>
            <th>Role</th>
            <th>Status</th>
            <th>Created</th>
            <th style="width: 10rem">Actions</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-user>
          <tr>
            <td>
              <div class="flex align-items-center gap-2">
                <div class="flex align-items-center justify-content-center bg-primary-100 border-round-xl"
                  style="width: 40px; height: 40px;">
                  <span class="font-bold text-primary">{{ user.username.charAt(0).toUpperCase() }}</span>
                </div>
                <span class="font-semibold">{{ user.username }}</span>
                @if (isCurrentUser(user)) {
                  <p-tag value="You" severity="info" styleClass="ml-2"></p-tag>
                }
              </div>
            </td>
            <td>{{ user.email }}</td>
            <td>
              <p-tag [value]="getRoleLabel(user.role)" [severity]="getRoleSeverity(user.role)"></p-tag>
            </td>
            <td>
              <p-tag [value]="getStatusLabel(user.status)" [severity]="getStatusSeverity(user.status)"></p-tag>
            </td>
            <td>{{ user.created_at | date:'mediumDate' }}</td>
            <td>
              <div class="flex gap-1">
                <p-button icon="pi pi-user-edit" [rounded]="true" [text]="true"
                  (onClick)="openRoleDialog(user)" pTooltip="Change Role"
                  [disabled]="isCurrentUser(user)"></p-button>
                <p-button icon="pi pi-power-off" [rounded]="true" [text]="true"
                  (onClick)="openStatusDialog(user)" pTooltip="Change Status"
                  [disabled]="isCurrentUser(user)"></p-button>
                <p-button icon="pi pi-trash" [rounded]="true" [text]="true" severity="danger"
                  (onClick)="confirmDeleteUser(user)" pTooltip="Delete"
                  [disabled]="isCurrentUser(user)"></p-button>
              </div>
            </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="6" class="text-center py-6">
              <i class="pi pi-users text-5xl text-color-secondary mb-3"></i>
              <p class="text-xl text-color-secondary">No users found</p>
            </td>
          </tr>
        </ng-template>
      </p-table>
    }
  </p-card>
</div>

<!-- Role Change Dialog -->
<p-dialog header="Change User Role" [(visible)]="showRoleDialog" [modal]="true" [style]="{width: '400px'}">
  @if (selectedUser) {
    <div class="flex flex-column gap-3">
      <p class="m-0">Change role for <strong>{{ selectedUser.username }}</strong></p>
      <div class="field">
        <label for="newRole" class="font-semibold">New Role</label>
        <p-dropdown id="newRole" [(ngModel)]="newRole" [options]="roleOptions"
          placeholder="Select role" styleClass="w-full"></p-dropdown>
      </div>
    </div>
  }
  <ng-template pTemplate="footer">
    <p-button label="Cancel" [text]="true" (onClick)="showRoleDialog = false"></p-button>
    <p-button label="Change Role" icon="pi pi-check" (onClick)="changeRole()"
      [loading]="isChangingRole" [disabled]="!newRole || newRole === selectedUser?.role"></p-button>
  </ng-template>
</p-dialog>

<!-- Status Change Dialog -->
<p-dialog header="Change User Status" [(visible)]="showStatusDialog" [modal]="true" [style]="{width: '400px'}">
  @if (selectedUser) {
    <div class="flex flex-column gap-3">
      <p class="m-0">Change status for <strong>{{ selectedUser.username }}</strong></p>
      <div class="field">
        <label for="newStatus" class="font-semibold">New Status</label>
        <p-dropdown id="newStatus" [(ngModel)]="newStatus" [options]="statusOptions"
          placeholder="Select status" styleClass="w-full"></p-dropdown>
      </div>
    </div>
  }
  <ng-template pTemplate="footer">
    <p-button label="Cancel" [text]="true" (onClick)="showStatusDialog = false"></p-button>
    <p-button label="Change Status" icon="pi pi-check" (onClick)="changeStatus()"
      [loading]="isChangingStatus" [disabled]="!newStatus || newStatus === selectedUser?.status"></p-button>
  </ng-template>
</p-dialog>
