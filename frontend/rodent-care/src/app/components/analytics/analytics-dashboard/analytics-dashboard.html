<p-toast position="top-right"></p-toast>

<div class="analytics-dashboard">
  <!-- Header -->
  <div class="flex align-items-center justify-content-between mb-4">
    <div>
      <h1 class="text-2xl font-bold text-color m-0">Analytics Dashboard</h1>
      <p class="text-color-secondary mt-1 mb-0">Comprehensive insights and reports</p>
    </div>
    <div class="flex align-items-center gap-3">
      <p-dropdown [options]="speciesOptions" [(ngModel)]="selectedSpecies" optionLabel="label" optionValue="value"
        (onChange)="onSpeciesChange()" styleClass="w-12rem" placeholder="Filter by Species"
        [showClear]="true"></p-dropdown>
      <p-dropdown [options]="periodOptions" [(ngModel)]="selectedPeriod" optionLabel="label" optionValue="value"
        (onChange)="onPeriodChange()" styleClass="w-10rem"></p-dropdown>
      <p-calendar [(ngModel)]="dateRange" selectionMode="range" [maxDate]="maxDate" dateFormat="yy-mm-dd"
        [showIcon]="true" placeholder="Custom Range" (onSelect)="onDateRangeChange()"></p-calendar>
    </div>
  </div>

  @if (isLoading) {
    <div class="flex justify-content-center py-6">
      <p-progressSpinner></p-progressSpinner>
    </div>
  } @else {
    <!-- Quick Stats -->
    @if (dashboardSummary) {
      <div class="grid mb-4">
        <div class="col-12 md:col-3">
          <p-card styleClass="h-full">
            <div class="text-center">
              <i class="pi pi-heart-fill text-4xl text-pink-500 mb-2"></i>
              <p class="text-color-secondary mb-1">Total Rodents</p>
              <p class="text-3xl font-bold m-0">{{ dashboardSummary.population.total_rodents }}</p>
            </div>
          </p-card>
        </div>
        <div class="col-12 md:col-3">
          <p-card styleClass="h-full">
            <div class="text-center">
              <i class="pi pi-clock text-4xl text-blue-500 mb-2"></i>
              <p class="text-color-secondary mb-1">Activity Today</p>
              <p class="text-3xl font-bold m-0">{{ dashboardSummary.activity.total_minutes_today }} min</p>
            </div>
          </p-card>
        </div>
        <div class="col-12 md:col-3">
          <p-card styleClass="h-full">
            <div class="text-center">
              <i class="pi pi-th-large text-4xl text-orange-500 mb-2"></i>
              <p class="text-color-secondary mb-1">Food Today</p>
              <p class="text-3xl font-bold m-0">{{ dashboardSummary.feeding.total_grams_today | number:'1.0-0' }}g</p>
            </div>
          </p-card>
        </div>
        <div class="col-12 md:col-3">
          <p-card styleClass="h-full">
            <div class="text-center">
              <i class="pi pi-plus-circle text-4xl text-green-500 mb-2"></i>
              <p class="text-color-secondary mb-1">New This Week</p>
              <p class="text-3xl font-bold m-0">{{ dashboardSummary.population.recent_intakes_week }}</p>
            </div>
          </p-card>
        </div>
      </div>
    }

    <p-tabView>
      <!-- Population Tab -->
      <p-tabPanel header="Population">
        <div class="flex justify-content-end mb-3">
          <p-button label="Export CSV" icon="pi pi-download" [outlined]="true" (onClick)="exportPopulation()"
            [loading]="isExporting"></p-button>
        </div>

        @if (populationStats) {
          <div class="grid">
            <!-- Species Distribution -->
            <div class="col-12 md:col-4">
              <p-card header="By Species">
                @if (speciesChartData) {
                  <p-chart type="pie" [data]="speciesChartData" [options]="pieOptions" [style]="{height: '300px'}"></p-chart>
                }
              </p-card>
            </div>

            <!-- Gender Distribution -->
            <div class="col-12 md:col-4">
              <p-card header="By Gender">
                @if (genderChartData) {
                  <p-chart type="doughnut" [data]="genderChartData" [options]="pieOptions" [style]="{height: '300px'}"></p-chart>
                }
              </p-card>
            </div>

            <!-- Status Distribution -->
            <div class="col-12 md:col-4">
              <p-card header="By Status">
                @if (statusChartData) {
                  <p-chart type="pie" [data]="statusChartData" [options]="pieOptions" [style]="{height: '300px'}"></p-chart>
                }
              </p-card>
            </div>

            <!-- Species Table -->
            <div class="col-12 lg:col-6">
              <p-card header="Species Breakdown">
                <p-table [value]="populationStats.by_species" [rows]="10" [paginator]="populationStats.by_species.length > 10">
                  <ng-template pTemplate="header">
                    <tr>
                      <th>Species</th>
                      <th class="text-right">Count</th>
                      <th class="text-right">Percentage</th>
                    </tr>
                  </ng-template>
                  <ng-template pTemplate="body" let-item>
                    <tr>
                      <td>{{ formatSpeciesLabel(item.species) }}</td>
                      <td class="text-right font-semibold">{{ item.count }}</td>
                      <td class="text-right">{{ item.percentage | number:'1.1-1' }}%</td>
                    </tr>
                  </ng-template>
                </p-table>
              </p-card>
            </div>

            <!-- Status Table -->
            <div class="col-12 lg:col-6">
              <p-card header="Status Breakdown">
                <p-table [value]="populationStats.by_status" [rows]="10" [paginator]="populationStats.by_status.length > 10">
                  <ng-template pTemplate="header">
                    <tr>
                      <th>Status</th>
                      <th class="text-right">Count</th>
                    </tr>
                  </ng-template>
                  <ng-template pTemplate="body" let-item>
                    <tr>
                      <td>
                        <p-tag [value]="formatStatusLabel(item.status)" [severity]="getStatusSeverity(item.status)"></p-tag>
                      </td>
                      <td class="text-right font-semibold">{{ item.count }}</td>
                    </tr>
                  </ng-template>
                </p-table>
              </p-card>
            </div>

            <!-- Summary Stats -->
            <div class="col-12">
              <p-card header="Summary">
                <div class="grid">
                  <div class="col-6 md:col-3 text-center">
                    <p class="text-color-secondary mb-1">Total Population</p>
                    <p class="text-2xl font-bold text-primary m-0">{{ populationStats.total_rodents }}</p>
                  </div>
                  <div class="col-6 md:col-3 text-center">
                    <p class="text-color-secondary mb-1">Recent Intakes (30d)</p>
                    <p class="text-2xl font-bold text-green-500 m-0">{{ populationStats.recent_intakes }}</p>
                  </div>
                  <div class="col-6 md:col-3 text-center">
                    <p class="text-color-secondary mb-1">Recent Adoptions (30d)</p>
                    <p class="text-2xl font-bold text-blue-500 m-0">{{ populationStats.recent_adoptions }}</p>
                  </div>
                  <div class="col-6 md:col-3 text-center">
                    <p class="text-color-secondary mb-1">Species Count</p>
                    <p class="text-2xl font-bold text-orange-500 m-0">{{ populationStats.by_species.length }}</p>
                  </div>
                </div>
              </p-card>
            </div>
          </div>
        }
      </p-tabPanel>

      <!-- Activity Tab -->
      <p-tabPanel header="Activity">
        <div class="flex justify-content-end mb-3">
          <p-button label="Export CSV" icon="pi pi-download" [outlined]="true" (onClick)="exportActivity()"
            [loading]="isExporting"></p-button>
        </div>

        @if (activityAnalytics) {
          <div class="grid">
            <!-- Activity Summary -->
            <div class="col-12">
              <p-card header="Activity Overview">
                <div class="grid">
                  <div class="col-6 md:col-3 text-center">
                    <p class="text-color-secondary mb-1">Total Activity</p>
                    <p class="text-2xl font-bold text-primary m-0">{{ activityAnalytics.total_activity_minutes }} min</p>
                  </div>
                  <div class="col-6 md:col-3 text-center">
                    <p class="text-color-secondary mb-1">Daily Average</p>
                    <p class="text-2xl font-bold text-green-500 m-0">{{ activityAnalytics.avg_daily_activity | number:'1.0-0' }} min</p>
                  </div>
                  <div class="col-6 md:col-3 text-center">
                    <p class="text-color-secondary mb-1">Activity Types</p>
                    <p class="text-2xl font-bold text-blue-500 m-0">{{ activityAnalytics.by_activity_type.length }}</p>
                  </div>
                  <div class="col-6 md:col-3 text-center">
                    <p class="text-color-secondary mb-1">Most Active Rodents</p>
                    <p class="text-2xl font-bold text-orange-500 m-0">{{ activityAnalytics.most_active_rodents.length }}</p>
                  </div>
                </div>
              </p-card>
            </div>

            <!-- Activity by Type -->
            <div class="col-12 md:col-6">
              <p-card header="Activity by Type">
                @if (activityTypeChartData) {
                  <p-chart type="bar" [data]="activityTypeChartData" [options]="basicOptions" [style]="{height: '300px'}"></p-chart>
                }
              </p-card>
            </div>

            <!-- Activity Trend -->
            <div class="col-12 md:col-6">
              <p-card header="Activity Trend">
                @if (activityTrendChartData) {
                  <p-chart type="line" [data]="activityTrendChartData" [options]="basicOptions" [style]="{height: '300px'}"></p-chart>
                }
              </p-card>
            </div>

            <!-- Hourly Activity -->
            <div class="col-12">
              <p-card header="Activity by Hour">
                @if (hourlyActivityChartData) {
                  <p-chart type="bar" [data]="hourlyActivityChartData" [options]="basicOptions" [style]="{height: '250px'}"></p-chart>
                }
              </p-card>
            </div>

            <!-- Activity Type Table -->
            <div class="col-12 lg:col-6">
              <p-card header="Activity Type Details">
                <p-table [value]="activityAnalytics.by_activity_type" [rows]="10">
                  <ng-template pTemplate="header">
                    <tr>
                      <th>Activity</th>
                      <th class="text-right">Total (min)</th>
                      <th class="text-right">Sessions</th>
                      <th class="text-right">Avg Duration</th>
                    </tr>
                  </ng-template>
                  <ng-template pTemplate="body" let-item>
                    <tr>
                      <td>{{ formatActivityTypeLabel(item.activity_type) }}</td>
                      <td class="text-right font-semibold">{{ item.total_minutes }}</td>
                      <td class="text-right">{{ item.session_count }}</td>
                      <td class="text-right">{{ item.avg_duration | number:'1.1-1' }} min</td>
                    </tr>
                  </ng-template>
                </p-table>
              </p-card>
            </div>

            <!-- Most Active Rodents -->
            <div class="col-12 lg:col-6">
              <p-card header="Most Active Rodents">
                <p-table [value]="activityAnalytics.most_active_rodents" [rows]="10">
                  <ng-template pTemplate="header">
                    <tr>
                      <th>Rodent</th>
                      <th class="text-right">Total (min)</th>
                      <th class="text-right">Sessions</th>
                    </tr>
                  </ng-template>
                  <ng-template pTemplate="body" let-item>
                    <tr>
                      <td>{{ item.rodent_name }}</td>
                      <td class="text-right font-semibold">{{ item.total_minutes }}</td>
                      <td class="text-right">{{ item.session_count }}</td>
                    </tr>
                  </ng-template>
                </p-table>
              </p-card>
            </div>
          </div>
        }
      </p-tabPanel>

      <!-- Feeding Tab -->
      <p-tabPanel header="Feeding">
        <div class="flex justify-content-end mb-3">
          <p-button label="Export CSV" icon="pi pi-download" [outlined]="true" (onClick)="exportFeeding()"
            [loading]="isExporting"></p-button>
        </div>

        @if (feedingAnalytics) {
          <div class="grid">
            <!-- Feeding Summary -->
            <div class="col-12">
              <p-card header="Feeding Overview">
                <div class="grid">
                  <div class="col-6 md:col-3 text-center">
                    <p class="text-color-secondary mb-1">Total Food</p>
                    <p class="text-2xl font-bold text-primary m-0">{{ feedingAnalytics.total_food_grams | number:'1.0-0' }}g</p>
                  </div>
                  <div class="col-6 md:col-3 text-center">
                    <p class="text-color-secondary mb-1">Daily Average</p>
                    <p class="text-2xl font-bold text-green-500 m-0">{{ feedingAnalytics.avg_daily_food | number:'1.0-0' }}g</p>
                  </div>
                  <div class="col-6 md:col-3 text-center">
                    <p class="text-color-secondary mb-1">Food Types</p>
                    <p class="text-2xl font-bold text-blue-500 m-0">{{ feedingAnalytics.by_food_type.length }}</p>
                  </div>
                  <div class="col-6 md:col-3 text-center">
                    <p class="text-color-secondary mb-1">Consumption Rate</p>
                    <p class="text-2xl font-bold text-orange-500 m-0">{{ feedingAnalytics.consumption_rate | number:'1.0-0' }}%</p>
                  </div>
                </div>
              </p-card>
            </div>

            <!-- Feeding by Type -->
            <div class="col-12 md:col-6">
              <p-card header="Feeding by Type">
                @if (feedingTypeChartData) {
                  <p-chart type="bar" [data]="feedingTypeChartData" [options]="basicOptions" [style]="{height: '300px'}"></p-chart>
                }
              </p-card>
            </div>

            <!-- Feeding Trend -->
            <div class="col-12 md:col-6">
              <p-card header="Feeding Trend">
                @if (feedingTrendChartData) {
                  <p-chart type="line" [data]="feedingTrendChartData" [options]="basicOptions" [style]="{height: '300px'}"></p-chart>
                }
              </p-card>
            </div>

            <!-- Hourly Feeding -->
            <div class="col-12">
              <p-card header="Feeding by Hour">
                @if (hourlyFeedingChartData) {
                  <p-chart type="bar" [data]="hourlyFeedingChartData" [options]="basicOptions" [style]="{height: '250px'}"></p-chart>
                }
              </p-card>
            </div>

            <!-- Food Type Table -->
            <div class="col-12 lg:col-6">
              <p-card header="Food Type Details">
                <p-table [value]="feedingAnalytics.by_food_type" [rows]="10">
                  <ng-template pTemplate="header">
                    <tr>
                      <th>Food Type</th>
                      <th class="text-right">Total (g)</th>
                      <th class="text-right">Feedings</th>
                      <th class="text-right">Avg Quantity</th>
                    </tr>
                  </ng-template>
                  <ng-template pTemplate="body" let-item>
                    <tr>
                      <td>{{ formatFoodTypeLabel(item.food_type) }}</td>
                      <td class="text-right font-semibold">{{ item.total_grams | number:'1.1-1' }}</td>
                      <td class="text-right">{{ item.feeding_count }}</td>
                      <td class="text-right">{{ item.avg_quantity | number:'1.1-1' }}g</td>
                    </tr>
                  </ng-template>
                </p-table>
              </p-card>
            </div>

            <!-- Top Consumers -->
            <div class="col-12 lg:col-6">
              <p-card header="Top Consumers">
                <p-table [value]="feedingAnalytics.top_consumers" [rows]="10">
                  <ng-template pTemplate="header">
                    <tr>
                      <th>Rodent</th>
                      <th class="text-right">Total (g)</th>
                      <th class="text-right">Feedings</th>
                    </tr>
                  </ng-template>
                  <ng-template pTemplate="body" let-item>
                    <tr>
                      <td>{{ item.rodent_name }}</td>
                      <td class="text-right font-semibold">{{ item.total_grams | number:'1.1-1' }}</td>
                      <td class="text-right">{{ item.feeding_count }}</td>
                    </tr>
                  </ng-template>
                </p-table>
              </p-card>
            </div>
          </div>
        }
      </p-tabPanel>

      <!-- Health Tab -->
      <p-tabPanel header="Health">
        @if (healthAnalytics) {
          <div class="grid">
            <!-- Health Summary -->
            <div class="col-12">
              <p-card header="Health Overview">
                <div class="grid">
                  <div class="col-6 md:col-3 text-center">
                    <p class="text-color-secondary mb-1">Weight Records</p>
                    <p class="text-2xl font-bold text-primary m-0">{{ healthAnalytics.weight_trends.length }}</p>
                  </div>
                  <div class="col-6 md:col-3 text-center">
                    <p class="text-color-secondary mb-1">Health Observations</p>
                    <p class="text-2xl font-bold text-orange-500 m-0">{{ healthAnalytics.health_observations_count }}</p>
                  </div>
                  <div class="col-6 md:col-3 text-center">
                    <p class="text-color-secondary mb-1">Energy Levels</p>
                    <p class="text-2xl font-bold text-green-500 m-0">{{ healthAnalytics.energy_level_distribution.length }}</p>
                  </div>
                  <div class="col-6 md:col-3 text-center">
                    <p class="text-color-secondary mb-1">Mood Levels</p>
                    <p class="text-2xl font-bold text-blue-500 m-0">{{ healthAnalytics.mood_level_distribution.length }}</p>
                  </div>
                </div>
              </p-card>
            </div>

            <!-- Weight Trend -->
            <div class="col-12">
              <p-card header="Weight Trend">
                @if (weightTrendChartData) {
                  <p-chart type="line" [data]="weightTrendChartData" [options]="basicOptions" [style]="{height: '300px'}"></p-chart>
                }
              </p-card>
            </div>

            <!-- Energy Level Distribution -->
            <div class="col-12 md:col-6">
              <p-card header="Energy Level Distribution">
                <p-table [value]="healthAnalytics.energy_level_distribution" [rows]="10">
                  <ng-template pTemplate="header">
                    <tr>
                      <th>Level</th>
                      <th class="text-right">Count</th>
                    </tr>
                  </ng-template>
                  <ng-template pTemplate="body" let-item>
                    <tr>
                      <td>{{ item.level }}/10</td>
                      <td class="text-right font-semibold">{{ item.count }}</td>
                    </tr>
                  </ng-template>
                </p-table>
              </p-card>
            </div>

            <!-- Mood Level Distribution -->
            <div class="col-12 md:col-6">
              <p-card header="Mood Level Distribution">
                <p-table [value]="healthAnalytics.mood_level_distribution" [rows]="10">
                  <ng-template pTemplate="header">
                    <tr>
                      <th>Level</th>
                      <th class="text-right">Count</th>
                    </tr>
                  </ng-template>
                  <ng-template pTemplate="body" let-item>
                    <tr>
                      <td>{{ item.level }}/10</td>
                      <td class="text-right font-semibold">{{ item.count }}</td>
                    </tr>
                  </ng-template>
                </p-table>
              </p-card>
            </div>
          </div>
        }
      </p-tabPanel>
    </p-tabView>
  }
</div>
