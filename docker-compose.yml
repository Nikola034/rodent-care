version: '3.8'

services:
  # PostgreSQL Database for User Service
  postgres:
    image: postgres:16-alpine
    container_name: rodent-care-postgres
    environment:
      POSTGRES_USER: rodentcare
      POSTGRES_PASSWORD: rodentcare_password
      POSTGRES_DB: rodent_care_users
    ports:
      - "5433:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - rodent-care-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U rodentcare -d rodent_care_users"]
      interval: 10s
      timeout: 5s
      retries: 5

  # MongoDB for future services (Rodent Registry, Activity Tracking, Analytics)
  mongodb:
    image: mongo:7.0
    container_name: rodent-care-mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: rodentcare
      MONGO_INITDB_ROOT_PASSWORD: rodentcare_password
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
    networks:
      - rodent-care-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  # RabbitMQ for async communication (future use)
  rabbitmq:
    image: rabbitmq:3.12-management-alpine
    container_name: rodent-care-rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: rodentcare
      RABBITMQ_DEFAULT_PASS: rodentcare_password
    ports:
      - "5672:5672"   # AMQP protocol
      - "15672:15672" # Management UI
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - rodent-care-network
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # User Service
  user-service:
    build:
      context: ./backend
      dockerfile: user-service/Dockerfile
    container_name: rodent-care-user-service
    environment:
      PORT: 8001
      DATABASE_URL: postgres://rodentcare:rodentcare_password@postgres:5432/rodent_care_users
      JWT_SECRET: your-super-secret-jwt-key-change-in-production-please
      JWT_EXPIRATION_HOURS: 24
      REFRESH_TOKEN_EXPIRATION_DAYS: 7
      RUST_LOG: info
    ports:
      - "8001:8001"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - rodent-care-network
    restart: unless-stopped

  # Rodent Registry Service
  rodent-registry-service:
    build:
      context: ./backend
      dockerfile: rodent-registry-service/Dockerfile
    container_name: rodent-care-rodent-registry-service
    environment:
      PORT: 8002
      MONGODB_URI: mongodb://rodentcare:rodentcare_password@mongodb:27017/?authSource=admin
      DATABASE_NAME: rodent_registry
      USER_SERVICE_URL: http://user-service:8001
      MAX_IMAGE_SIZE_MB: 5
      RABBITMQ_URL: amqp://rodentcare:rodentcare_password@rabbitmq:5672
      JWT_SECRET: your-super-secret-jwt-key-change-in-production-please
      RUST_LOG: info
    ports:
      - "8002:8002"
    depends_on:
      mongodb:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      user-service:
        condition: service_started
    networks:
      - rodent-care-network
    restart: unless-stopped

  # Activity Tracking Service
  activity-tracking-service:
    build:
      context: ./backend
      dockerfile: activity-tracking-service/Dockerfile
    container_name: rodent-care-activity-tracking-service
    environment:
      PORT: 8003
      MONGODB_URI: mongodb://rodentcare:rodentcare_password@mongodb:27017/?authSource=admin
      DATABASE_NAME: activity_tracking
      USER_SERVICE_URL: http://user-service:8001
      RABBITMQ_URL: amqp://rodentcare:rodentcare_password@rabbitmq:5672
      JWT_SECRET: your-super-secret-jwt-key-change-in-production-please
      RUST_LOG: info
    ports:
      - "8003:8003"
    depends_on:
      mongodb:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      user-service:
        condition: service_started
    networks:
      - rodent-care-network
    restart: unless-stopped

  # Analytics Service
  analytics-service:
    build:
      context: ./backend
      dockerfile: analytics-service/Dockerfile
    container_name: rodent-care-analytics-service
    environment:
      PORT: 8004
      MONGODB_URI: mongodb://rodentcare:rodentcare_password@mongodb:27017/?authSource=admin
      DATABASE_NAME: analytics
      RODENT_SERVICE_URL: http://rodent-registry-service:8002
      ACTIVITY_SERVICE_URL: http://activity-tracking-service:8003
      RABBITMQ_URL: amqp://rodentcare:rodentcare_password@rabbitmq:5672
      JWT_SECRET: your-super-secret-jwt-key-change-in-production-please
      RUST_LOG: info
    ports:
      - "8004:8004"
    depends_on:
      mongodb:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      rodent-registry-service:
        condition: service_started
      activity-tracking-service:
        condition: service_started
    networks:
      - rodent-care-network
    restart: unless-stopped

  # API Gateway
  api-gateway:
    build:
      context: ./backend
      dockerfile: api-gateway/Dockerfile
    container_name: rodent-care-api-gateway
    environment:
      PORT: 8000
      USER_SERVICE_URL: http://user-service:8001
      RODENT_REGISTRY_SERVICE_URL: http://rodent-registry-service:8002
      ACTIVITY_TRACKING_SERVICE_URL: http://activity-tracking-service:8003
      ANALYTICS_SERVICE_URL: http://analytics-service:8004
      RATE_LIMIT_REQUESTS: 100
      RATE_LIMIT_WINDOW_SECS: 60
      RUST_LOG: info
    ports:
      - "8000:8000"
    depends_on:
      - user-service
      - rodent-registry-service
      - activity-tracking-service
      - analytics-service
    networks:
      - rodent-care-network
    restart: unless-stopped

  # Angular Frontend
  frontend:
    build:
      context: ./frontend/rodent-care
      dockerfile: Dockerfile
    container_name: rodent-care-frontend
    ports:
      - "4200:80"
    depends_on:
      - api-gateway
    networks:
      - rodent-care-network
    restart: unless-stopped

networks:
  rodent-care-network:
    driver: bridge

volumes:
  postgres_data:
  mongodb_data:
  rabbitmq_data:
